service: market-project

custom:
  prefixName: myMarket
  itemTableName: ${self:custom.prefixName}-itemTable
  transTableName: ${self:custom.prefixName}-transTable
  topicName: SendClosedTrans

plugins:
  - serverless-offline

provider:
  name: aws
  runtime: nodejs12.x
  region: eu-west-3
  stage: ${opt:stage, 'dev'}
  environment:
    itemTableName: ${self:custom.itemTableName}
    transTableName: ${self:custom.transTableName}
    snsCloseTrans: !Ref SnsCloseTrans

  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:*
      Resource: '*'
    - Effect: Allow
      Action:
        - SNS:Publish
      Resource:
        - !Ref SnsCloseTrans

functions:
  getItem:
    handler: src/handlers/getItem.handler
    events:
      - http:
          path: /item/{id}
          method: get
  putItem:
    handler: src/handlers/putItem.handler
    events:
      - http:
          path: /item
          method: post
  openTrans:
    handler: src/handlers/openTrans.handler
    events:
      - http:
          path: /trans/create/{cname}
          method: post
  progressTrans:
    handler: src/handlers/progressTrans.handler
    events:
      - http:
          path: /trans/{transId}
          method: post
  closeTrans:
    handler: src/handlers/closeTrans.handler
    events:
      - http:
          path: /trans/close/{transId}
          method: post
  sendEmail:
    handler: src/handlers/sendEmail.handler
    events:
      - sns:
          arn: !Ref SnsCloseTrans
          topicName: ${self:custom.topicName}

resources:
  Resources:
    SnsCloseTrans:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:custom.topicName}
    ItemTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.itemTableName}
        AttributeDefinitions:
          - AttributeName: itemId
            AttributeType: S
          - AttributeName: title
            AttributeType: S
          - AttributeName: price
            AttributeType: N
          - AttributeName: quantity
            AttributeType: N
        KeySchema:
          - AttributeName: itemId
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
    TransTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.transTableName}
        AttributeDefinitions:
          - AttributeName: transId
            AttributeType: S
          - AttributeName: transStatus
            AttributeType: S
          - AttributeName: toPay
            AttributeType: N
        KeySchema:
          - AttributeName: transId
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
